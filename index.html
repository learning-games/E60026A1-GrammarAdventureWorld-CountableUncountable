<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>‡πÄ‡∏Å‡∏°-GrammarAdventureWorld ‡∏ô‡∏≤‡∏°‡∏ô‡∏±‡∏ö‡πÑ‡∏î‡πâ-‡∏ô‡∏≤‡∏°‡∏ô‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ</title>
<style>
/* ===== ‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏£‡∏ß‡∏°‡∏´‡∏ô‡πâ‡∏≤ (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ===== */
@font-face{
  font-family: 'MyGameFont';
  src: url('image/THSarabunNew.woff2') format('woff2'),
       url('image/THSarabunNew.woff') format('woff'),
       url('image/THSarabunNew.ttf') format('truetype');
  font-weight: 400; font-style: normal; font-display: swap;
}
@font-face{
  font-family: 'MyGameFont';
  src: url('image/THSarabunNewBold.woff2') format('woff2'),
       url('image/THSarabunNewBold.woff') format('woff'),
       url('image/THSarabunNewBold.ttf') format('truetype');
  font-weight: 700; font-style: normal; font-display: swap;
}
html, body, button, input, select, textarea, .pill, .btn, .btn-mini,
.levelBtn, #startTitle, #countdown, .label, #timer {
  font-family: 'MyGameFont', system-ui, -apple-system, 'Segoe UI', Arial, sans-serif;
}

:root{
  --glass: rgba(0,0,0,.45);
  --ok: #10b981;
  --bad: #ef4444;
  --hud-top: 15px;
  --safe-top: env(safe-area-inset-top, 0px);

  /* ‚úÖ NEW: ‡∏¢‡∏Å‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡∏∂‡πâ‡∏ô/‡∏•‡∏á (‡∏Ñ‡πà‡∏≤‡∏ï‡∏¥‡∏î‡∏•‡∏ö = ‡∏Ç‡∏∂‡πâ‡∏ô, ‡∏Ñ‡πà‡∏≤‡∏ö‡∏ß‡∏Å = ‡∏•‡∏á) */
  --qUp: -150px;
  /* ‚úÖ NEW: ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏´‡∏•‡∏±‡∏Å (‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏î‡πâ‡∏ß‡∏¢ JS) */
  --mainBg: url("image/background2.png");
}

*{ box-sizing:border-box }
html,body{ height:100%; margin:0 }
body{
  background: var(--mainBg) center center / cover no-repeat fixed !important;
  overflow:hidden; color:#fff;
}
#game{ position:relative; width:100vw; height:100vh; overflow:hidden }


/* ===== HUD (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ===== */
.hud{
  position:fixed;
  inset: calc(var(--safe-top) + var(--hud-top)) 5px auto 38px !important;
  display:flex;
  align-items:center;
  gap:12px;
  justify-content:space-between;
  pointer-events:none;
  z-index:40000;
}
/* ‡∏ã‡πà‡∏≠‡∏ô HUD ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà in-game */
body:not(.in-game):not(.prestart) .hud { display:none !important; }
/* ‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤ ‡πÇ‡∏ú‡∏•‡πà‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô in-game */
body:not(.in-game) #clock { display:none !important; }

/* ===== Game Clock (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏° ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡πÇ‡∏ä‡∏ß‡πå‡∏Å‡∏•‡∏≤‡∏á‡∏ö‡∏ô) ===== */
#clock.clock-pill{
  position:fixed; top:14px; left:50%; transform:translateX(-50%);
  z-index:16000; pointer-events:none;
  --clock-size: 40px; font-size: var(--clock-size);
  background: var(--glass); backdrop-filter: blur(6px);
  color:#fff; font-weight:1000; line-height:1; border-radius:999px;
  padding:8px 16px; box-shadow:0 4px 18px rgba(0,0,0,.25);
  text-shadow:0 3px 10px rgba(0,0,0,.55);
}
@media (max-width:480px){
  #clock.clock-pill{ --clock-size: 28px; padding:6px 12px; }
}

.pill{ background:var(--glass); backdrop-filter:blur(6px); padding:8px 12px; border-radius:999px; box-shadow:0 4px 18px rgba(0,0,0,.25) }
#timer{ font-weight:700; font-variant-numeric:tabular-nums; letter-spacing:.5px; font-size:20px }
.btn-mini{ pointer-events:auto; background:#1f2937; color:#fff; border:none; border-radius:12px; padding:8px 12px; font-weight:800; cursor:pointer; box-shadow:0 4px 18px rgba(0,0,0,.25) }
.btn-mini:hover{ filter:brightness(1.1) }

.pill.gold{
  --score-emoji-size: 32px;
  background: var(--glass);
  border-radius: 999px;
  padding: 6px 12px;
  line-height: 1;
  display: inline-flex;
  align-items: center;
  justify-content: flex-start;
  gap: 4px;

  width: auto;
  max-width: none;
  white-space: nowrap;
  overflow: visible;

  font-size: var(--score-emoji-size);
  box-shadow: 0 4px 18px rgba(0,0,0,.25);
}

.pill.gold .score-num{
  font-size: 0.9em;
  font-weight: 900;
  margin-right: 6px;
}
.pill.gold .score-icons{ display:inline-block; }
.pill.gold .num{ display:none; }

@media (max-width:480px){
  .pill.gold{
    --score-emoji-size: 24px;
    max-width: min(360px, 90vw);
  }
}

/* ===== Welcome / Landing (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ===== */
#landing{ position:fixed; inset:0; display:flex; flex-direction:column; gap:22px; align-items:center; justify-content:center; background: var(--mainBg) center/cover no-repeat fixed !important; z-index:20000; transition:opacity .3s ease }
#landing.hide{ opacity:0; pointer-events:none; visibility:hidden }
#landing .brand{ width:min(92vw,1100px) }
#landing .brand img{ width:100%; height:auto; display:block; filter:drop-shadow(0 10px 30px rgba(0,0,0,.6)) }
#welcome{ position:fixed; inset:0; background:url("image/welcome.png") center/cover no-repeat fixed; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:24px; z-index:25000; transition:opacity .3s ease; }
#welcome.hide{ opacity:0; pointer-events:none; visibility:hidden }
#welcome #enterBtn{ padding:12px 28px; font-size:clamp(22px,4vw,36px); font-weight:1000; letter-spacing:.2px; border:0; border-radius:16px; color:#fff; background:rgba(0,0,0,.55); box-shadow:0 10px 28px rgba(0,0,0,.35); cursor:pointer; backdrop-filter:blur(6px); border:1px solid rgba(255,255,255,.18) }
#welcome .brand{ width:min(90vw,1000px); margin-bottom:100px; display:flex; justify-content:center }
#welcome .brand img{
  width:130%;
  height:auto;
  display:block;
  animation: none !important;
  filter:drop-shadow(0 6px 18px rgba(0,0,0,.45))
}
#welcome .welcome-content{ display:flex; flex-direction:column; align-items:center; gap:0; margin-top:100px }
@keyframes pulse{ 0%,100%{transform:scale(1);opacity:1} 50%{transform:scale(1.04);opacity:.9} }
.level-menu{ display:flex; flex-direction:column; gap:14px; width:min(92vw,640px) }
.levelBtn{ width:100%; padding:10px 16px; font-size:clamp(20px,4vw,34px); font-weight:1000; letter-spacing:.2px; border:0; border-radius:14px; color:#fff; background:rgba(0,0,0,.55); box-shadow:0 10px 28px rgba(0,0,0,.35); cursor:pointer; text-align:center; border:1px solid rgba(255,255,255,.18); backdrop-filter:blur(6px) }

/* ===== ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°/‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ===== */
#startScreen{
  position:fixed; inset:0; display:none; flex-direction:column; align-items:center; justify-content:center;
  background:#000;   z-index:30000; text-align:center; padding:24px;
}
#startTitle{ font-size:clamp(26px,5vw,48px); font-weight:900; margin-bottom:10px }
#startBtn{ margin-top:12px; padding:10px 18px; border:0; border-radius:12px; font-weight:800; cursor:pointer; background:#1f2937; color:#fff }
#countdown{ display:none; font-size:clamp(56px,12vw,120px); font-weight:1000; line-height:1; margin-top:8px }

/* ===== ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô ‚Äú‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û + ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ï‡πâ‡∏£‡∏π‡∏õ‚Äù ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°/‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö) ===== */
#questionBox{
  position:fixed;
  left:0;
  top:0;

  /* ‚úÖ NEW: ‡πÄ‡∏û‡∏¥‡πà‡∏° --qUp ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô‡πÅ‡∏Å‡∏ô Y */
  translate: var(--qx, 50vw) calc(var(--qy, 50vh) + var(--qUp, 0px));
  transform: translate(-50%, -20%) scale(.9);

  z-index: 12000;
  pointer-events:none;

  opacity: 0;
  transition:
    opacity   800ms cubic-bezier(.2,.8,.2,1),
    transform 800ms cubic-bezier(.2,.8,.2,1);
  will-change: translate, transform, opacity;

  /* ‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡∏ï‡πå‡∏†‡∏≤‡∏¢‡πÉ‡∏ô */
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap: 12px;
  padding: 10px 14px;
  text-align:center;
  white-space: normal;
}

/* ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) */
#questionBox::before{
  background: transparent;
  box-shadow: none;
}

#questionBox:empty::before{ display:none; }

#questionBox.in{
  opacity: 1;
  transform: translate(-50%, -20%) scale(1);
}
#questionBox.out{
  opacity: 0;
  transform: translate(-50%, -20%) scale(.85);
  transition: none;
  animation: qboxOutPop 900ms cubic-bezier(.2,.8,.2,1) forwards;
}
@keyframes qboxOutPop{
  0%{ opacity: 1; transform: translate(-50%, -20%) scale(1); }
  40%{ opacity: 1; transform: translate(-50%, -20%) scale(1.06); }
  100%{ opacity: 0; transform: translate(-50%, -20%) scale(.85); }
}

/* ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° */
#qImg{
  display:block;
  width: min(60vw, 520px);
  max-height: min(42vh, 360px);
  height:auto;
  object-fit: contain;
  filter: drop-shadow(0 10px 26px rgba(0,0,0,.35));
  border-radius: 18px;
}

/* ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ï‡πâ‡∏£‡∏π‡∏õ */
#qCaption{
  font-size: clamp(30px, 4.6vw, 60px);
  font-weight: 1000;
  line-height: 1.1;
  text-shadow:0 3px 10px rgba(0,0,0,.55);
  padding: 10px 18px;
  border-radius: 16px;
  background: rgba(0,0,0,.35);
  border: 1px solid rgba(255,255,255,.18);
  box-shadow:0 6px 14px rgba(0,0,0,0.25);
  max-width: min(70vw, 640px);
}

/* ‚úÖ NEW: ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡∏ï‡∏±‡∏ß s (‡∏™‡∏µ‡πÅ‡∏î‡∏á + ‡πÄ‡∏ü‡∏î) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "‡∏õ‡∏∏‡πà‡∏°‡∏ã‡πâ‡∏≤‡∏¢" ‡πÉ‡∏ô‡∏î‡πà‡∏≤‡∏ô 3 */
.zone .btn-line2 .btn-s{
  color: var(--bad);
  display: inline-block;
  opacity: 0;
  transform: translateY(-6px);
  animation: btnSFade 520ms ease forwards;
}
@keyframes btnSFade{
  to{ opacity: 1; transform: translateY(0); }
}

/* ‡∏õ‡∏¥‡∏î‡∏≠‡∏µ‡πÇ‡∏°‡∏à‡∏¥‡πÄ‡∏î‡∏¥‡∏° (‡∏¢‡∏±‡∏á‡∏Ñ‡∏á element ‡πÑ‡∏ß‡πâ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ) */
#qEmoji{ display:none !important; }

/* ===== ‡πÅ‡∏ñ‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ / ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå / ‡πÇ‡∏≠‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÄ‡∏•‡∏¢‡πå (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ===== */
#timebarWrap{ position:fixed; left:0; right:0; bottom:0; height:12px; background:rgba(255,255,255,.12); z-index:16000; border-top:1px solid rgba(255,255,255,.2); display:none !important }
#flash{ position:fixed; inset:0; background:transparent; pointer-events:none; z-index:17000 }

/* ‚úÖ ADD: ‡πÅ‡∏ü‡∏•‡∏ä‡πÅ‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏à‡∏≠ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ö‡∏ú‡∏¥‡∏î) */
#flash.badflash{
  animation: badFlashScreen 640ms ease-out forwards;
}
@keyframes badFlashScreen{
  0%   { background: rgba(239,68,68,0.00); }
  20%  { background: rgba(239,68,68,0.45); }
  65%  { background: rgba(239,68,68,0.45); } 
  100% { background: rgba(239,68,68,0.00); }
}
#roundToast{ position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,.78); border:1px solid rgba(255,255,255,.22); padding:18px 26px; border-radius:16px; font-size:clamp(22px,3vw,34px); font-weight:900; z-index:17500; display:none; text-align:center; white-space:nowrap; line-height:1.25; }
#ansImg{ position:fixed; inset:0; width:100vw; height:100vh; object-fit:cover; object-position:center; opacity:.95; filter: drop-shadow(0 20px 60px rgba(0,0,0,.50)); z-index:17499; display:none; pointer-events:none; }

/* ===== ‡∏Å‡∏•‡πâ‡∏≠‡∏á/‡πÅ‡∏Ñ‡∏ô‡∏ß‡∏≤‡∏™ AR (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ===== */
#cameraMirror{ position:fixed; inset:0; width:100vw; height:100vh; object-fit:cover; transform: scaleX(-1); z-index:1; display:none; background:#000 }
#camCanvas{ position:fixed; inset:0; width:100vw; height:100vh; z-index:2; pointer-events:none; display:none }

/* ‡∏õ‡∏∏‡πà‡∏° Mute / Fullscreen (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) */
#muteBtn, #fsBtn{
  position: fixed; right: 12px; width: 44px; height: 44px; border-radius: 999px; background: rgba(0,0,0,.45);
  border: 1px solid rgba(255,255,255,.3); color: #fff; font-size: 18px; line-height: 1; display: grid; place-items: center; cursor: pointer; z-index: 50000;
}
#muteBtn{ bottom:12px } #fsBtn{ bottom:62px }

/* ===== ‡∏°‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏î‡∏±‡∏ö (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ===== */
body::after{ content:""; position:fixed; top:0; left:0; width:var(--corner-img-w, 220px); height:var(--corner-img-h, 220px); background:url("image/button1.png") no-repeat left top / contain; pointer-events:none; z-index:10000 }
body::before{ content:""; position:fixed; top:0; right:0; width:var(--corner2-img-w, 200px); height:var(--corner2-img-h, 200px); background:url("image/button2.png") no-repeat right top / contain; pointer-events:none; z-index:10000 }

/* ===== ‡∏£‡∏π‡∏õ‡∏õ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏° (plus1/plus2) ===== */
:root{
  /* plus ‡∏õ‡∏Å‡∏ï‡∏¥ */
  --plus1-left: -100px;
  --plus1-bottom: -80px;
  --plus1-w: 24vw;

  --plus2-right: -100px;
  --plus2-bottom: -80px;
  --plus2-w: 24vw;
  --plus-z: 45000;
}


.plus-deco{
  position: fixed;
  bottom: 0;
  width: auto;
  height: auto;
  pointer-events: none;
  user-select: none;
  z-index: var(--plus-z);
  display: none;
}
body.in-game .plus-deco{ display:block; }

/* ‚úÖ NEW: ‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á -> ‡∏ã‡πà‡∏≠‡∏ô plus ‡∏õ‡∏Å‡∏ï‡∏¥ */
body.cam-on #plus1Deco,
body.cam-on #plus2Deco{ display:none !important; }
/* ‡∏ã‡πà‡∏≠‡∏ô plus ‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏°‡∏≠ */
.plus-deco-cam{ display:none !important; }

/* ‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á ‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (active) */
body.in-game.cam-on .plus-deco-cam.active{ display:block !important; }


#plus1Deco{ left: var(--plus1-left); bottom: var(--plus1-bottom); width: var(--plus1-w); }
#plus2Deco{ right: var(--plus2-right); bottom: var(--plus2-bottom); width: var(--plus2-w); }

.fly-score{
  position:fixed;
  left:0;
  top:0;
  font-weight:1000;
  font-size: clamp(70px, 10vw, 120px);
  pointer-events:none;
  z-index:20000;
  opacity:0;
  transform:translate(-50%,-10px);
  animation:flyUp 900ms ease-out forwards;
  text-shadow:0 6px 20px rgba(0,0,0,.55);
}
.fly-score.ok{ color:#10b981 } .fly-score.bad{ color:#ef4444 }
@keyframes flyUp{ 0%{opacity:0; transform:translate(-50%, 10px) scale(.96);} 15%{opacity:1; transform:translate(-50%, 0) scale(1);} 100%{opacity:0; transform:translate(-50%, -60px) scale(1.06);} }

/* ===== ‡πÇ‡∏ã‡∏ô‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö 25%‚Äì50%‚Äì25% ===== */
#zones{
  position:fixed;
  inset:0;
  display:grid;
  grid-template-columns: 1.3fr 1.4fr 1.3fr; /* ‚úÖ ‡∏ã‡πâ‡∏≤‡∏¢‚Äì‡∏Ç‡∏ß‡∏≤‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô */
  z-index: 11000;
  pointer-events:none;
}

body:not(.in-game) .zone .ansbtn{
  opacity:0 !important;
  pointer-events:none !important;
  transform: scale(.96);
}
.zone{ position:relative; }

/* ===== ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏™‡∏≠‡∏á‡∏ù‡∏±‡πà‡∏á (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô: ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‚Äú‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‚Äù ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ç‡∏≠) ===== */
.zone .ansbtn {
  position: absolute;
  left: 0;
  width: 100%;
  height: 90%;
  min-height: 320px;     /* ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡∏Ç‡∏≠‡∏á‡∏õ‡∏∏‡πà‡∏° */
  padding: 24px 12px;    /* ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏≤‡∏ô‡πÉ‡∏ô */
  top: 2%;
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
  font-weight: 1000;
  font-size: clamp(26px,3.6vw,54px);
  letter-spacing: .5px;
  color: #fff;

  background: none !important;
  border: none !important;
  box-shadow: none !important;
  outline: none !important;

  pointer-events: auto;
  user-select: none;
  cursor: pointer;
  overflow: hidden;
  padding: 10px 12px;
}

/* ‡∏ó‡∏≥‡∏Å‡∏£‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° */
.zone .btn-content{
  display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  width:100%; height:100%;
  gap:0;
  position: relative;
}

/* ‚úÖ NEW: ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° 2 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î */
.zone .btn-text{
  position: relative;
  z-index: 2;

  display: inline-flex;              /* NEW */
  flex-direction: column;            /* NEW */
  align-items: center;               /* NEW */
  justify-content: center;           /* NEW */
  gap: 6px;                          /* NEW: ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î */

  line-height: 1.1;
  white-space: normal;
  max-width: 92%;
  min-width: clamp(280px, 26vw, 480px);   /* ‚úÖ ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏´‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πâ‡∏ô */
  min-height: 110px;                      /* ‚úÖ ‡∏™‡∏π‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ ‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏™‡∏°‡∏î‡∏∏‡∏• */
  text-shadow: 0 3px 10px rgba(0,0,0,.45);
  color: #fff;
  padding: 14px 22px;
  border: none;
  border-radius: 18px;
  box-shadow: 0 10px 22px rgba(0,0,0,0.35);
}

/* ‚úÖ NEW: ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ö‡∏ô (‡πÉ‡∏´‡∏ç‡πà) */
.zone .btn-line1{
  font-size: var(--btnLine1Size, clamp(28px, 4vw, 56px));
  font-weight: 1000;
}

/* ‚úÖ NEW: ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏•‡πà‡∏≤‡∏á (‡πÄ‡∏•‡πá‡∏Å‡∏Å‡∏ß‡πà‡∏≤ + ‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏≠‡∏¥‡∏™‡∏£‡∏∞) */
.zone .btn-line2{
  font-size: var(--btnLine2Size, clamp(16px, 2.2vw, 28px));
  font-weight: 900;
  opacity: .95;
}

/* ‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢/‡∏Ç‡∏ß‡∏≤ */
.zone.left .btn-text{
  background: linear-gradient(180deg,
    var(--btnLeftA,  #6ee7b7) 0%,
    var(--btnLeftB,  #10b981) 100%
  );
}
.zone.right .btn-text{
  background: linear-gradient(180deg,
    var(--btnRightA, #fca5a5) 0%,
    var(--btnRightB, #ef4444) 100%
  );
}

/* ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á (‡∏Ñ‡∏á‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡πÄ‡∏î‡∏¥‡∏°) */
.zone .ansbtn:hover .btn-text,
.zone .ansbtn.armed .btn-text{ transform: scale(1.03); }

.zone .ansbtn{ transition: opacity .18s ease, transform .18s ease; }
.zone .ansbtn.out{
  opacity: 0;
  transform: scale(.96);
  pointer-events: none;
  transition: opacity 280ms ease, transform 280ms ease !important;
}
.zone .ansbtn.hidden{
  opacity: 0;
  pointer-events: none;
  transform: scale(.96);
}

/* ===== HUD ‡∏ï‡∏£‡∏∂‡∏á‡∏ã‡πâ‡∏≤‡∏¢/‡∏Ç‡∏ß‡∏≤ (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ===== */
.hud { position: initial !important; inset: auto !important; }
.hud .left, .hud .right {
  position: fixed !important; top: var(--hud-top) !important;
  z-index: 40000 !important; pointer-events: none;
}
.hud .left { left: 20px !important; }
.hud .right { right: 20px !important; }
.hud .btn-mini { pointer-events:auto; }
#goldWrap:empty{ display:none; }

/* ===== Result Panel (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ===== */
.result-panel{
  --panel-bg: rgba(20,20,20,.92);
  --panel-br: 20px;
  --panel-bd: 1px solid rgba(255,255,255,.12);
  --shadow: 0 20px 60px rgba(0,0,0,.55);
  background: var(--panel-bg);
  border: var(--panel-bd);
  padding: clamp(20px, 4vw, 32px);
  border-radius: var(--panel-br);
  width: min(92vw, 640px);
  display: grid; grid-template-rows: auto auto auto auto;
  gap: clamp(12px, 2vw, 18px); text-align: center; box-shadow: var(--shadow); backdrop-filter: blur(6px);
}

/* ‚úÖ NEW: ‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤ guide ‡πÉ‡∏ä‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏Å */
#guideScreen{
  background: var(--mainBg) center/cover no-repeat fixed !important;
}

.result-title{ margin:0; font-weight:1000; font-size:clamp(28px,4.5vw,44px); letter-spacing:.2px; text-shadow:0 4px 14px rgba(0,0,0,.35) }
.badge{ font-size:clamp(56px,10vw,120px); line-height:1; filter: drop-shadow(0 8px 24px rgba(0,0,0,.45)); margin:6px 0 4px }
.result-metrics{ display:grid; grid-template-columns:1fr; gap:clamp(10px,2vw,16px); margin-top:4px }
.metric{ background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); border-radius:16px; padding:clamp(10px,2vw,16px); box-shadow:0 8px 26px rgba(0,0,0,.25) inset, 0 8px 24px rgba(0,0,0,.25) }
.metric .label{ font-size:clamp(14px,2.2vw,18px); opacity:.9; margin-bottom:4px }
.metric .value{ font-size:clamp(28px,5.5vw,52px); font-weight:1000; line-height:1; letter-spacing:.3px }
.result-actions{ display:flex; gap:12px; justify-content:center; flex-wrap:wrap; margin-top:6px }
.btn{ appearance:none; border:none; border-radius:14px; padding:clamp(10px,2.2vw,14px) clamp(16px,3.5vw,24px); font-weight:900; font-size:clamp(16px,2.8vw,20px); cursor:pointer; box-shadow:0 10px 28px rgba(0,0,0,.35); transition: transform .08s ease, filter .15s ease, box-shadow .15s ease; }
.btn:active{ transform: translateY(1px) scale(.99); }
.btn.strong{ color:#fff; background:linear-gradient(180deg,#3b82f6,#1d4ed8); border:1px solid rgba(255,255,255,.15) }
.btn.strong:hover{ filter:brightness(1.08) }
.btn.ghost{ color:#fff; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.18) }
.btn.ghost:hover{ filter:brightness(1.1) }

/* ‡∏õ‡∏∏‡πà‡∏° ‚Äú‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‚Äù ‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠ (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) */
#nextQuestionBtn{
  position:fixed;
  left:50%;
  top:50%;
  transform:translate(-50%, -50%);
  z-index:30050;
  padding:600px 170px;
  border:none;
  border-radius:20px;
  cursor:pointer;
  background:transparent !important;
  color:transparent !important;
  box-shadow:none !important;
  outline:none !important;
  border:none !important;
  opacity:0;
  pointer-events:auto;
  display:none;
}
#nextQuestionBtn:active{ transform:translate(-50%, -48%) scale(.98); }

/* ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏≠‡πÑ‡∏õ‡∏Ç‡πâ‡∏≠‡∏ï‡πà‡∏≠‡πÑ‡∏õ (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) */
#nextHint{
  position:fixed;
  left:50%;
  bottom:8vh;
  transform:translateX(-50%) scale(.7);
  z-index:30040;
  padding:1.2vh 4vw;
  font-size:clamp(18px, 3vw, 26px);
  max-width:90vw;
  text-align:center;
  border-radius:999px;
  background:rgba(0,0,0,.65);
  color:#fff;
  box-shadow:0 10px 28px rgba(0,0,0,.45);
  opacity:0;
  display:none;
  pointer-events:none;
  transition:
    opacity   260ms cubic-bezier(.2,.8,.2,1),
    transform 260ms cubic-bezier(.2,.8,.2,1);
}
#nextHint.in{ opacity:1; transform:translateX(-50%) scale(1); }
#nextHint.out{ opacity:0; transform:translateX(-50%) scale(.5); }
</style>
</head>
<body>

<!-- ==== AR Mirror (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ==== -->
<video id="cameraMirror" playsinline muted></video>
<canvas id="camCanvas"></canvas>

<div id="game" aria-label="‡∏™‡∏ô‡∏≤‡∏°‡πÄ‡∏Å‡∏°">
  <div id="questionBox" aria-live="polite">
    <img id="qImg" alt="‡∏†‡∏≤‡∏û‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°" />
    <div id="qCaption"></div>
  </div>
  <!-- ‡∏≠‡∏µ‡πÇ‡∏°‡∏à‡∏¥‡πÄ‡∏î‡∏¥‡∏° (‡∏Ñ‡∏á element ‡πÑ‡∏ß‡πâ ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ) -->
  <div id="qEmoji" aria-hidden="true"></div>
</div>

<!-- ‡πÇ‡∏ã‡∏ô‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö 25%-50%-25% -->
<div id="zones" aria-hidden="false">
  <div class="zone left">
    <div id="btnTrueBlend" class="ansbtn hidden" role="button" aria-label="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏ô‡∏≤‡∏°‡∏ô‡∏±‡∏ö‡πÑ‡∏î‡πâ">
      <div class="btn-content">
        <div class="btn-text">
          <span class="btn-line1">‡∏ô‡∏≤‡∏°‡∏ô‡∏±‡∏ö‡πÑ‡∏î‡πâ</span>
          <span class="btn-line2">‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏•‡πà‡∏≤‡∏á</span>
        </div>
      </div>
    </div>
  </div>

  <div class="zone mid" aria-hidden="true"></div>

  <div class="zone right">
    <div id="btnFalseBlend" class="ansbtn hidden" role="button" aria-label="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏ô‡∏≤‡∏°‡∏ô‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ">
      <div class="btn-content">
        <div class="btn-text">
          <span class="btn-line1">‡∏ô‡∏≤‡∏°‡∏ô‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ</span>
          <span class="btn-line2">‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏•‡πà‡∏≤‡∏á</span>
        </div>
      </div>
    </div>
  </div>
</div>



<!-- ===== ‡∏£‡∏π‡∏õ‡∏õ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏° (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ/‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏∞‡∏•‡∏∏) ===== -->
<img id="plus1Deco" class="plus-deco" src="image/plus1.png" alt="">
<img id="plus2Deco" class="plus-deco" src="image/plus2.png" alt="">
<!-- ‚úÖ NEW: ‡∏£‡∏π‡∏õ plus ‡∏û‡∏¥‡πÄ‡∏®‡∏© (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô) -->
<!-- ‚úÖ NEW: ‡∏£‡∏π‡∏õ plus ‡∏û‡∏¥‡πÄ‡∏®‡∏© (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô) -->
<img id="plus1DecoCam"  class="plus-deco plus-deco-cam" src="image/plus1_cam.png"  alt="">
<img id="plus2DecoCam"  class="plus-deco plus-deco-cam" src="image/plus2_cam.png"  alt="">
<img id="plus3DecoCam"  class="plus-deco plus-deco-cam" src="image/plus3_cam.png"  alt="">
<img id="plus4DecoCam"  class="plus-deco plus-deco-cam" src="image/plus4_cam.png"  alt="">
<img id="plus5DecoCam"  class="plus-deco plus-deco-cam" src="image/plus5_cam.png"  alt="">
<img id="plus6DecoCam"  class="plus-deco plus-deco-cam" src="image/plus6_cam.png"  alt="">
<img id="plus7DecoCam"  class="plus-deco plus-deco-cam" src="image/plus7_cam.png"  alt="">
<img id="plus8DecoCam"  class="plus-deco plus-deco-cam" src="image/plus8_cam.png"  alt="">
<img id="plus9DecoCam"  class="plus-deco plus-deco-cam" src="image/plus9_cam.png"  alt="">
<img id="plus10DecoCam" class="plus-deco plus-deco-cam" src="image/plus10_cam.png" alt="">
<img id="plus11DecoCam" class="plus-deco plus-deco-cam" src="image/plus11_cam.png" alt="">
<img id="plus12DecoCam" class="plus-deco plus-deco-cam" src="image/plus12_cam.png" alt="">
<img id="plus13DecoCam" class="plus-deco plus-deco-cam" src="image/plus13_cam.png" alt="">
<img id="plus14DecoCam" class="plus-deco plus-deco-cam" src="image/plus14_cam.png" alt="">
<img id="plus15DecoCam" class="plus-deco plus-deco-cam" src="image/plus15_cam.png" alt="">
<img id="plus16DecoCam" class="plus-deco plus-deco-cam" src="image/plus16_cam.png" alt="">



<!-- ===== Welcome (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ===== -->
<div id="welcome" role="dialog" aria-modal="true">
  <div class="welcome-content">
    <div class="brand"><img src="image/banner2.png" alt="Banner"></div>
    <button id="enterBtn">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÄ‡∏Å‡∏°</button>
  </div>
</div>

<!-- ===== Landing (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ===== -->
<div id="landing" role="dialog" aria-modal="true" class="hide">
  <div class="brand"><img src="image/banner2.png" alt="Banner"></div>
  <div class="level-menu">
    <button class="levelBtn" data-level="1">Countable / Uncountable Noun</button>
<button class="levelBtn" data-level="2">There is A / There is some</button>
<button class="levelBtn" data-level="3">How many / How much</button>
    <button class="levelBtn" id="guideBtn">‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô üìñ</button>
  </div>
</div>

<!-- ===== ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à / ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏° (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ===== -->
<div id="startScreen">
  <div id="startTitle">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à : ‡∏à‡∏±‡∏î‡∏´‡∏°‡∏ß‡∏î ‚Äú‡∏ô‡∏≤‡∏°‡∏ô‡∏±‡∏ö‡πÑ‡∏î‡πâ / ‡∏ô‡∏≤‡∏°‡∏ô‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‚Äù ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</div>
  <button id="startBtn">‡πÄ‡∏£‡∏¥‡πà‡∏°</button>
  <div id="countdown">3</div>
</div>

<!-- ===== ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠ (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ===== -->
<div id="guideScreen" style="display:none; position:fixed; inset:0; align-items:center; justify-content:center; z-index:20001">
  <div class="guide-wrap" style="width:min(95vw, 1200px); max-height:92vh; display:flex; flex-direction:column; gap:10px; align-items:center; justify-content:center">
    <img src="image/guide.png" alt="‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡πÄ‡∏Å‡∏°" style="width:100%; height:auto; max-height:92vh; border-radius:14px; box-shadow:0 20px 60px rgba(0,0,0,.55); display:block">
    <button id="guideBack" class="btn-mini">‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</button>
  </div>
</div>

<!-- ===== HUD (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ===== -->
<div class="hud">
  <div class="left">
    <div class="stack">
      <div style="display:flex; gap:8px;">
        <button id="quickRestart" class="btn-mini">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
        <button id="pauseBtn" class="btn-mini">‚è∏ ‡∏´‡∏¢‡∏∏‡∏î</button>
        <button id="camBtn" class="btn-mini">üì∑: ‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </div>
  <div class="right">
    <div class="stack" style="align-items:flex-end">
      <div id="goldWrap" class="pill gold" aria-live="polite" title="‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô"></div>
    </div>
  </div>
</div>

<!-- ===== ‡πÅ‡∏ñ‡∏ö‡πÄ‡∏ß‡∏•‡∏≤/‡πÅ‡∏ü‡∏•‡∏ä/‡πÇ‡∏ó‡∏™‡∏ï‡πå/‡∏£‡∏π‡∏õ‡∏ú‡∏• (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ===== -->
<div id="timebarWrap"><div id="timebar"></div></div>
<div id="flash"></div>
<div id="roundToast"></div>
<img id="ansImg" src="" alt="answer background">

<!-- ‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏õ‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (‡πÇ‡∏ú‡∏•‡πà‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß) -->
<button id="nextQuestionBtn" type="button" class="next-btn" aria-label="‡πÑ‡∏õ‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ">
  ‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚ñ∂
</button>
<div id="nextHint" aria-hidden="true">
  ‡πÇ‡∏õ‡∏£‡∏î‡∏¢‡∏∑‡∏ô‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
</div>

<!-- ===== ‡∏õ‡πä‡∏≠‡∏õ‡∏≠‡∏±‡∏õ‡∏à‡∏ö‡∏î‡πà‡∏≤‡∏ô (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ===== -->
<div id="overlay" style="visibility:hidden; opacity:0; transition:.25s; position:fixed; inset:0; display:grid; place-items:center; background:rgba(0,0,0,.55); z-index:9999">
  <div class="result-panel">
    <div class="badge" id="scoreBadge" aria-hidden="true">üèÜ</div>
    <h1 class="result-title" id="endTitle">‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤</h1>
    <div class="result-metrics">
      <div class="metric">
        <div class="label">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
        <div class="value"><b id="finalScore">0</b></div>
      </div>
    </div>
    <div class="result-actions">
      <button class="btn strong" id="restartBtn">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
      <button class="btn ghost" id="selectLevelBtn">‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
    </div>
  </div>
</div>

<!-- ===== ‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ===== -->
<audio id="hitSound" preload="auto" src="image/audio1.mp3"></audio>
<audio id="winSound" preload="auto" src="image/win2.mp3"></audio>
<audio id="bgm" preload="auto" loop src="image/bgm3.mp3"></audio>
<audio id="questionSound" preload="auto" src="image/question.mp3"></audio>
<audio id="correctSound" preload="auto" src="image/audio.mp3"></audio>
<audio id="wrongSound"   preload="auto" src="image/wrong.mp3"></audio>

<!-- ===== ‡∏õ‡∏∏‡πà‡∏° Mute / Fullscreen (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ===== -->
<button id="muteBtn" aria-pressed="false" title="Mute / Unmute">üîä</button>
<button id="fsBtn" aria-pressed="false" title="‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠">‚õ∂</button>

<!-- ===== ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° Mute (‡∏õ‡∏¥‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞ BGM) ===== -->
<script>
(function(){
  const muteBtn = document.getElementById('muteBtn');
  const bgm = document.getElementById('bgm');
  if(!muteBtn || !bgm) return;

  let isMuted = false;
  let lastBgmVolume = bgm.volume || 0.3;

  function applyMute(m){
    isMuted = !!m;

    if(isMuted){
      lastBgmVolume = bgm.volume || lastBgmVolume;
      bgm.muted = true;
      bgm.pause();
    }else{
      bgm.muted = false;
      bgm.volume = lastBgmVolume;
      bgm.play?.().catch(()=>{});
    }

    muteBtn.setAttribute('aria-pressed', String(isMuted));
    muteBtn.textContent = isMuted ? 'üîá' : 'üîä';
  }

  muteBtn.addEventListener('click', () => applyMute(!isMuted));
})();
</script>

<!-- ===== ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° Fullscreen (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ===== -->
<script>
(function(){
  const fsBtn = document.getElementById('fsBtn');
  if (!fsBtn) return;
  function fsEnabled(){ return document.fullscreenEnabled || document.webkitFullscreenEnabled || document.msFullscreenEnabled }
  function isFull(){ return document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement }
  function requestFS(){ const el=document.documentElement; (el.requestFullscreen||el.webkitRequestFullscreen||el.msRequestFullscreen)?.call(el) }
  function exitFS(){ (document.exitFullscreen||document.webkitExitFullscreen||document.msExitFullscreen)?.call(document) }
  function render(){ const on=!!isFull(); fsBtn.setAttribute('aria-pressed', String(on)); fsBtn.title = on ? '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠' : '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠'; fsBtn.textContent = on ? 'üóó' : '‚õ∂' }
  if (!fsEnabled()){ fsBtn.style.display='none'; return }
  fsBtn.addEventListener('click', () => { if(isFull()) exitFS(); else requestFS() });
  document.addEventListener('fullscreenchange', render);
  document.addEventListener('webkitfullscreenchange', render);
  document.addEventListener('msfullscreenchange', render);
  render();
})();
</script>

<!-- ===== ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Å‡∏°: (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î) ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ‚Äú‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°/‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏î‡πà‡∏≤‡∏ô 1‚Äù ===== -->
<script>
(()=>{

/* ---------- DOM ‡∏´‡∏•‡∏±‡∏Å ---------- */
const qBox   = document.getElementById('questionBox');
const qImg   = document.getElementById('qImg');
const qCap   = document.getElementById('qCaption');

const overlay= document.getElementById('overlay');
const finalScoreEl = document.getElementById('finalScore');
const restartBtn   = document.getElementById('restartBtn');
const selectLevelBtn = document.getElementById('selectLevelBtn');
const pauseBtn = document.getElementById('pauseBtn');
const quickRestart = document.getElementById('quickRestart');
const bgm = document.getElementById('bgm');

const plusCamTestBtn = document.getElementById('plusCamTestBtn'); // ‚úÖ NEW

/* ‚úÖ NEW: ‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏ã‡πá‡∏ï plus ‡∏û‡∏¥‡πÄ‡∏®‡∏© (cam mode) 8 ‡πÄ‡∏ã‡πá‡∏ï (‡πÄ‡∏ã‡πá‡∏ï‡∏•‡∏∞ 2 ‡∏£‡∏π‡∏õ) */
const PLUS_CAM_SETS = [
  ['plus1DecoCam','plus2DecoCam'],
  ['plus3DecoCam','plus4DecoCam'],
  ['plus5DecoCam','plus6DecoCam'],
  ['plus7DecoCam','plus8DecoCam'],
  ['plus9DecoCam','plus10DecoCam'],
  ['plus11DecoCam','plus12DecoCam'],
  ['plus13DecoCam','plus14DecoCam'],
  ['plus15DecoCam','plus16DecoCam'],
];

let __lastPlusSet = -1;

function applyRandomPlusCamSet(){
  for(const pair of PLUS_CAM_SETS){
    for(const id of pair){
      const el = document.getElementById(id);
      if(el) el.classList.remove('active');
    }
  }

  let pick = (Math.random() * PLUS_CAM_SETS.length) | 0;
  if(PLUS_CAM_SETS.length > 1 && pick === __lastPlusSet){
    pick = (pick + 1 + ((Math.random()* (PLUS_CAM_SETS.length-1))|0)) % PLUS_CAM_SETS.length;
  }
  __lastPlusSet = pick;

  for(const id of PLUS_CAM_SETS[pick]){
    const el = document.getElementById(id);
    if(el) el.classList.add('active');
  }

  // ‚úÖ copy ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á: ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
  const baseL = document.getElementById('plus1Deco');
  const baseR = document.getElementById('plus2Deco');

  const pair = PLUS_CAM_SETS[pick];
  const leftCam  = document.getElementById(pair[0]);
  const rightCam = document.getElementById(pair[1]);

  if(baseL && leftCam){
    const cs = getComputedStyle(baseL);
    leftCam.style.left   = cs.left;
    leftCam.style.right  = 'auto';
    leftCam.style.bottom = cs.bottom;
    leftCam.style.width  = cs.width;
  }
  if(baseR && rightCam){
    const cs = getComputedStyle(baseR);
    rightCam.style.right  = cs.right;
    rightCam.style.left   = 'auto';
    rightCam.style.bottom = cs.bottom;
    rightCam.style.width  = cs.width;
  }
}

function hideCamPlus(){
  // ‚úÖ ‡πÑ‡∏°‡πà‡∏¢‡∏∏‡πà‡∏á‡∏Å‡∏±‡∏ö cam-on (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏°‡∏±‡∏ô‡∏Ñ‡∏∑‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏•‡πâ‡∏≠‡∏á/‡∏ï‡∏£‡∏∂‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°)
  // document.body.classList.remove('cam-on'); // ‚ùå ‡πÄ‡∏≠‡∏≤‡∏≠‡∏≠‡∏Å

  // ‡∏ñ‡∏≠‡∏î active ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å plus cam ‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß
  for(const pair of PLUS_CAM_SETS){
    for(const id of pair){
      document.getElementById(id)?.classList.remove('active');
    }
  }
}



const hitSound = document.getElementById('hitSound');
const winSound = document.getElementById('winSound');
const correctSound = document.getElementById('correctSound');
const wrongSound   = document.getElementById('wrongSound');
const questionSound = document.getElementById('questionSound');

const VOL = {
  bgm: 0.3,
  hit: 1,
  win: 1,
  correct: 1.0,
  wrong: 1.0,
  question: 0.8
};

/* ‚úÖ NEW: ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏û‡∏¥‡πÄ‡∏®‡∏© (‡∏™‡∏∏‡πà‡∏° bg1-bg4) */
const SPECIAL_BG_POOL = [
  "image/bg1.png",
  "image/bg2.png",
  "image/bg3.png",
  "image/bg4.png",
];

let __lastSpecialBg = null;

function setMainBg(url){
  // --mainBg ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏õ‡πá‡∏ô url("...") ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ CSS background ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
  document.documentElement.style.setProperty('--mainBg', `url("${url}")`);
}

function pickSpecialBg(){
  if(SPECIAL_BG_POOL.length <= 1) return SPECIAL_BG_POOL[0];

  let pick = null;
  let guard = 10;
  do{
    pick = SPECIAL_BG_POOL[(Math.random() * SPECIAL_BG_POOL.length) | 0];
    guard--;
  }while(pick === __lastSpecialBg && guard > 0);

  __lastSpecialBg = pick;
  return pick;
}

function applySpecialBg(){
  const bg = pickSpecialBg();
  setMainBg(bg);
}

function restoreDefaultBg(){
  setMainBg("image/background2.png");
}

if (bgm) bgm.volume = VOL.bgm;
if (hitSound) hitSound.volume = VOL.hit;
if (winSound) winSound.volume = VOL.win;
if (correctSound) correctSound.volume = VOL.correct;
if (wrongSound) wrongSound.volume = VOL.wrong;
if (questionSound) questionSound.volume = VOL.question;

function playClone(el, volume){
  try{
    const a = el?.cloneNode(true);
    if (!a) return;
    a.volume = volume;
    a.currentTime = 0;
    a.play?.();
  }catch(_){}
}

const goldWrap = document.getElementById('goldWrap');
const nextQuestionBtn = document.getElementById('nextQuestionBtn');
const nextHintEl = document.getElementById('nextHint');
/* ‚úÖ ADD: ‡πÅ‡∏ü‡∏•‡∏ä‡πÅ‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏à‡∏≠ (‡∏ï‡∏≠‡∏ö‡∏ú‡∏¥‡∏î‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô) */
const flashEl = document.getElementById('flash');
function flashWrongScreen(){
  if(!flashEl) return;
  flashEl.classList.remove('badflash');
  void flashEl.offsetWidth;          // ‚úÖ restart animation
  flashEl.classList.add('badflash');
}
flashEl?.addEventListener('animationend', ()=>flashEl.classList.remove('badflash'));

/* ‚úÖ NEW: ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÇ‡∏ä‡∏ß‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ */
let nextHintDelayT = null;

/* ---------- ‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤‡∏ö‡∏ô HUD (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ---------- */
const clockEl = document.createElement('div');
clockEl.id = 'clock';
clockEl.className = 'clock-pill';
clockEl.textContent = '02:00';
document.body.appendChild(clockEl);
clockEl.style.display = 'none';

let clockUIItv=null, clockState='idle';
const CLEAR_DELAY_MS = 1500;
const QBOX_OUT_MS    = 900;
const BTN_FADE_MS    = 900;

const GAME_DURATION_MS=120000;
let gameTimerId=null, gameEndAt=0, remainingMs=GAME_DURATION_MS;

function fmtClock(ms){ const total=Math.max(0,Math.ceil(ms/1000)); const m=String(Math.floor(total/60)).padStart(2,'0'); const s=String(total%60).padStart(2,'0'); return m+':'+s }
function renderClockFromGame(){ const ms=(clockState==='run')?Math.max(0, (gameEndAt - performance.now())):remainingMs; clockEl.textContent=fmtClock(ms) }
function startClockUI(){ clockState='run'; if(!clockUIItv) clockUIItv=setInterval(renderClockFromGame, 250); renderClockFromGame() }
function pauseClockUI(){ clockState='pause'; if(clockUIItv){ clearInterval(clockUIItv); clockUIItv=null } renderClockFromGame() }
function resumeClockUI(){ clockState='run'; if(!clockUIItv) clockUIItv=setInterval(renderClockFromGame, 250); renderClockFromGame() }
function stopClockUI(){ clockState='end'; if(clockUIItv){ clearInterval(clockUIItv); clockUIItv=null } renderClockFromGame() }
function resetClockUI(){ clockState='idle'; if(clockUIItv){ clearInterval(clockUIItv); clockUIItv=null } clockEl.textContent=fmtClock(GAME_DURATION_MS) }

function scheduleGameTimer(ms){
  clearTimeout(gameTimerId);
  gameTimerId=setTimeout(()=>{ if(!ended) endLevel() }, Math.max(0, ms|0));
}
function startGameTimer(){ remainingMs=GAME_DURATION_MS; gameEndAt=performance.now()+remainingMs; scheduleGameTimer(remainingMs); startClockUI() }
function pauseGameTimer(){ if(gameTimerId){ remainingMs=Math.max(0, gameEndAt - performance.now()); clearTimeout(gameTimerId); gameTimerId=null; } pauseClockUI() }
function resumeGameTimer(){ if(remainingMs>0 && !ended){ gameEndAt=performance.now()+remainingMs; scheduleGameTimer(remainingMs); resumeClockUI() } }

/* ---------- ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô/‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ---------- */
let running=false, ended=true, paused=false;
let score=0, round=0;
let answeredCount = 0;
let emojiHistory = [];
const MAX_QUESTIONS = 15;

let canAnswer = false;
let waitingNext = false;
let questionCount = 0;

/* ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô */
function renderGold(n){
  const score = Math.max(0, Number(n) || 0);

  if (emojiHistory.length === 0){
    goldWrap.style.display = 'none';
    goldWrap.innerHTML = '';
    goldWrap.removeAttribute('aria-label');
    return;
  }

  goldWrap.style.display = 'inline-flex';
  const MAX_ICONS = 40;
  const icons = emojiHistory.slice(-MAX_ICONS).join('');

  goldWrap.innerHTML = `
    <span class="score-icons">${icons}</span>
    <span class="score-num">${score}</span>
  `;

  const iconCount = Math.min(emojiHistory.length, MAX_ICONS);
  let size = 32;
  if (iconCount > 15) size = 28;
  if (iconCount > 25) size = 24;
  if (iconCount > 35) size = 20;
  goldWrap.style.setProperty('--score-emoji-size', size + 'px');

  goldWrap.setAttribute('aria-label',`‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ${score} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô`);
}

const SCORE_EMOJI_POSITIVE = ['üòÑ'];
const SCORE_EMOJI_NEGATIVE = ['üò°'];
function pickScoreEmoji(isOk){
  const pool = isOk ? SCORE_EMOJI_POSITIVE : SCORE_EMOJI_NEGATIVE;
  if (!pool.length) return isOk ? 'üòÑ' : 'üò°';
  return pool[(Math.random() * pool.length) | 0];
}
function flyScoreAtCenter(ok, anchorEl, offsetX = 0, offsetY = -40){
  const sp = document.createElement('div');
  sp.className = 'fly-score ' + (ok ? 'ok' : 'bad');
  sp.textContent = pickScoreEmoji(ok);

  if (anchorEl){
    const r = anchorEl.getBoundingClientRect();
    const x = r.left + r.width/2 + offsetX;
    const y = r.top  + r.height/2 + offsetY;
    sp.style.left = x + 'px';
    sp.style.top  = y + 'px';
  } else {
    sp.style.left = (innerWidth/2) + 'px';
    sp.style.top  = (innerHeight/2) + 'px';
  }

  document.body.appendChild(sp);
  sp.addEventListener('animationend', () => sp.remove(), { once:true });
}

/* ‡πÇ‡∏ä‡∏ß‡πå/‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏° "‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ" */
if(nextHintEl){
  nextHintEl.addEventListener('transitionend', (e)=>{
    if(e.propertyName === 'opacity' && nextHintEl.classList.contains('out')){
      nextHintEl.style.display = 'none';
    }
  });
}

function showNextButton(show){
  if(!nextQuestionBtn) return;

  // ‚úÖ ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏î‡∏µ‡πÄ‡∏•‡∏¢‡πå‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
  if(nextHintDelayT){
    clearTimeout(nextHintDelayT);
    nextHintDelayT = null;
  }

  if(show){
    nextQuestionBtn.style.display='inline-flex';

    if(nextHintEl){
      // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: ‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏°‡∏≠ ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÇ‡∏ä‡∏ß‡πå‡∏´‡∏•‡∏±‡∏á 4 ‡∏ß‡∏¥
      nextHintEl.classList.remove('in','out');
      nextHintEl.style.display = 'none';

      nextHintDelayT = setTimeout(()=>{
        // ‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏õ‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Å‡∏°‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß
        if(!waitingNext || ended) return;

        const headOn = !!(window.__HEAD_TRACK__ && window.__HEAD_TRACK__.on);
        nextHintEl.textContent = headOn
          ? '‡πÇ‡∏õ‡∏£‡∏î‡∏¢‡∏∑‡∏ô‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ'
          : '‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏Å‡∏•‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ';

        nextHintEl.classList.remove('out');
        nextHintEl.style.display = 'block';
        void nextHintEl.offsetWidth; // force reflow
        nextHintEl.classList.add('in');
      }, 3000);
    }

  }else{
    nextQuestionBtn.style.display='none';

    if(nextHintEl){
      // ‡∏ã‡πà‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö‡πÄ‡∏ô‡∏µ‡∏¢‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà)
      nextHintEl.classList.remove('in');
      nextHintEl.classList.add('out');
    }
  }
}


/* ---------- ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Ñ‡∏≥ (‡πÄ‡∏î‡∏¥‡∏°‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡πà‡∏≤‡∏ô 2-3) ---------- */
const BANK_L2_TRUE = [];
const BANK_L2_FALSE = [];
const BANK_L3_TRUE = [];
const BANK_L3_FALSE = [];

/* ====== ‚úÖ ‡∏î‡πà‡∏≤‡∏ô 1: ‡∏ô‡∏≤‡∏°‡∏ô‡∏±‡∏ö‡πÑ‡∏î‡πâ/‡∏ô‡∏≤‡∏°‡∏ô‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û + ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ï‡πâ‡∏£‡∏π‡∏õ) ======
   - ‡∏£‡∏π‡∏õ: data1/nouns1-30.png (‡∏ô‡∏≤‡∏°‡∏ô‡∏±‡∏ö‡πÑ‡∏î‡πâ)
   - ‡∏£‡∏π‡∏õ: data2/nouns1-30.png (‡∏ô‡∏≤‡∏°‡∏ô‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)
   - ‡∏ú‡∏π‡∏Å ‚Äúcaption‚Äù ‡πÅ‡∏ö‡∏ö 1 ‡∏£‡∏π‡∏õ = 1 caption = 1 ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
*/
const COUNTABLE_LABEL  = "‡∏ô‡∏≤‡∏°‡∏ô‡∏±‡∏ö‡πÑ‡∏î‡πâ";
const UNCOUNTABLE_LABEL= "‡∏ô‡∏≤‡∏°‡∏ô‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ";

/* ‚úÖ 30 ‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡πà‡∏ô (‡∏ô‡∏≤‡∏°‡∏ô‡∏±‡∏ö‡πÑ‡∏î‡πâ) ‚Äî ‡∏ö‡∏≠‡∏™‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏π‡∏õ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Ñ‡∏≥‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ */
const COUNTABLE_CAPTIONS = [
  "apple",
  "book",
  "pencil",
  "pen",
  "candy",
  "coin",
  "sausage",
  "glass",
  "can",
  "computer",

  "phone",
  "ball",
  "school",
  "car",
  "cookie",
  "train",
  "bicycle",
  "owl",
  "bat",
  "bag",

  "doughnut",
  "bottle",
  "student",
  "burger",
  "house",
  "sandwich",
  "tree",
  "flower",
  "cup",
  "fan",
];

/* ‚úÖ 30 ‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡πà‡∏ô (‡∏ô‡∏≤‡∏°‡∏ô‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ) ‚Äî ‡∏ö‡∏≠‡∏™‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏π‡∏õ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Ñ‡∏≥‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ */
const UNCOUNTABLE_CAPTIONS = [
  "water",
  "milk",
  "juice",
  "rice",
  "sugar",
  "salt",
  "flour",
  "bread",
  "butter",
  "cheese",
  "coffee",
  "tea",
  "oil",
  "honey",
  "chocolate",
  "ice",
  "grass",
  "sand",
  "soil",
  "mud",
  "smoke",
  "meat",
  "snow",
  "furniture",
  "luggage",
  "soap",
  "hair",
  "money",
  "cake",
  "soup",
];

/* ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á pool ‡∏î‡πà‡∏≤‡∏ô 1 (60 ‡∏Ç‡πâ‡∏≠) ‡πÅ‡∏ö‡∏ö‡∏ú‡∏π‡∏Å caption + ‡πÄ‡∏â‡∏•‡∏¢ */
function buildNounsPool(){
  const arr = [];

  // 30 ‡∏£‡∏π‡∏õ: ‡∏ô‡∏≤‡∏°‡∏ô‡∏±‡∏ö‡πÑ‡∏î‡πâ (data1)
  for(let i=1;i<=30;i++){
    arr.push({
      src: `data1/nouns${i}.png`,
      caption: COUNTABLE_CAPTIONS[i-1] ?? `countable #${i}`,
      isTrue: true, // ‚úÖ ‡∏ã‡πâ‡∏≤‡∏¢ = ‡∏ô‡∏≤‡∏°‡∏ô‡∏±‡∏ö‡πÑ‡∏î‡πâ
    });
  }

  // 30 ‡∏£‡∏π‡∏õ: ‡∏ô‡∏≤‡∏°‡∏ô‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (data2)
  for(let i=1;i<=30;i++){
    arr.push({
      src: `data2/nouns${i}.png`,
      caption: UNCOUNTABLE_CAPTIONS[i-1] ?? `uncountable #${i}`,
      isTrue: false, // ‚úÖ ‡∏Ç‡∏ß‡∏≤ = ‡∏ô‡∏≤‡∏°‡∏ô‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
    });
  }

  // ‡∏™‡∏∏‡πà‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö
  for(let i=arr.length-1;i>0;i--){
    const j=(Math.random()*(i+1))|0;
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }

  return arr;
}


/* ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∏‡∏î‡∏Ñ‡∏≥‡∏ï‡∏≤‡∏°‡∏î‡πà‡∏≤‡∏ô */
let currentLevel = 1;

/* ===== ‡πÄ‡∏°‡∏ï‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πà‡∏≠‡∏î‡πà‡∏≤‡∏ô (‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏î‡πà‡∏≤‡∏ô 1 ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ç‡∏≠) ===== */
const LEVEL_META = {
  1: {
    left1:  COUNTABLE_LABEL,
    left2:  'Countable Noun',
    right1: UNCOUNTABLE_LABEL,
    right2: 'Uncountable Noun',
    title: '‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à : ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå'
  },
  2: {
    left1:  'There is a/an ...',
    left2:  '',
    right1: 'There is some ...',
    right2: '',
    title: '‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à : ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å There is a/an ‡∏´‡∏£‡∏∑‡∏≠ There is some ‡πÉ‡∏´‡πâ‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå'
  },
  3: {
    left1:  'How many ...?',
    left2:  '',
    right1: 'How much ...?',
    right2: '',
    title: '‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à : ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å How many ‡∏´‡∏£‡∏∑‡∏≠ How much ‡πÉ‡∏´‡πâ‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå'
  }
};



function getBankForLevel(lv){
  if(lv===2) return { TRUE:BANK_L2_TRUE.slice(), FALSE:BANK_L2_FALSE.slice() };
  if(lv===3) return { TRUE:BANK_L3_TRUE.slice(), FALSE:BANK_L3_FALSE.slice() };
  return { TRUE:[], FALSE:[] };
}

/* ‡∏™‡∏∏‡πà‡∏°‡∏£‡∏ß‡∏°‡∏Ñ‡∏≥ + ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á */
let pool = []; // [{...}]
function buildPool(lv){
  // ‚úÖ ‡∏î‡πà‡∏≤‡∏ô 1‚Äì3 ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ+caption ‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å pool ‡∏î‡πà‡∏≤‡∏ô 1 ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  if(lv===1 || lv===2 || lv===3){
    pool = buildNounsPool();
    return;
  }

  // (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï: ‡∏î‡πà‡∏≤‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ bank ‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏î‡πâ)
  const {TRUE, FALSE} = getBankForLevel(lv);
  const arr=[];
  TRUE.forEach(w=>arr.push({word:w, isTrue:true}));
  FALSE.forEach(w=>arr.push({word:w, isTrue:false}));
  for(let i=arr.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [arr[i],arr[j]]=[arr[j],arr[i]] }
  pool = arr;
}


/* ---------- ‡∏Å‡∏•‡πÑ‡∏Å‡∏ñ‡∏≤‡∏°-‡∏ï‡∏≠‡∏ö ---------- */
let idx=0;

/* ‚úÖ NEW: timeout ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ï‡∏¥‡∏° s ‡πÉ‡∏ô‡∏î‡πà‡∏≤‡∏ô 3 */
let btnPluralT = null;   // ‚úÖ NEW: timeout ‡πÄ‡∏ï‡∏¥‡∏° s ‡∏ó‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏°‡∏ã‡πâ‡∏≤‡∏¢ (‡∏î‡πà‡∏≤‡∏ô 3)

/* ‚úÖ NEW: ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏Å‡∏±‡∏ô‡∏ö‡∏±‡∏Ñ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏î‡πâ‡∏á‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ) */
function cancelPendingFlows(){
  // 1) ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå timeout ‡∏Ç‡∏≠‡∏á‡∏î‡πà‡∏≤‡∏ô 3 (‡πÄ‡∏ï‡∏¥‡∏° s)
  if(btnPluralT){ clearTimeout(btnPluralT); btnPluralT=null; }

  // 2) ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏î‡∏µ‡πÄ‡∏•‡∏¢‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° nextHint
  if(nextHintDelayT){ clearTimeout(nextHintDelayT); nextHintDelayT=null; }

  // 3) ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå timeout ‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡∏≤‡∏Å judge()
  if(judge._fadeBtnsT){ clearTimeout(judge._fadeBtnsT); judge._fadeBtnsT=null; }
  if(judge._clearT){ clearTimeout(judge._clearT); judge._clearT=null; }
  judge._busy = false;

  // 4) ‡∏õ‡∏¥‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ ‚Äú‡πÑ‡∏õ‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‚Äù ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ
  waitingNext = false;
  canAnswer = false;

  // 5) ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°/‡∏Ñ‡∏≥‡πÉ‡∏ö‡πâ‡πÑ‡∏õ‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÅ‡∏ö‡∏ö‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö
  if(nextQuestionBtn) nextQuestionBtn.style.display = 'none';
  if(nextHintEl){
    nextHintEl.classList.remove('in','out');
    nextHintEl.style.display = 'none';
  }

  // ‚úÖ FIX: ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏Å‡∏±‡∏ô‡∏Ñ‡∏•‡∏≤‡∏™ .out ‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏≤‡∏¢
  btnTrue?.classList.remove('out','armed');
  btnFalse?.classList.remove('out','armed');

  // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÄ‡∏Å‡∏° ‡πÉ‡∏´‡πâ‡∏ã‡πà‡∏≠‡∏ô‡∏î‡πâ‡∏ß‡∏¢ hidden ‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô (‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢)
  // (‡∏ï‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡πÉ‡∏´‡∏°‡πà showAnswerButtons(true) ‡∏à‡∏∞‡∏ñ‡∏≠‡∏î hidden ‡πÄ‡∏≠‡∏á)
  btnTrue?.classList.add('hidden');
  btnFalse?.classList.add('hidden');
}



// ‚úÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å a/an ‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢ (‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÅ‡∏£‡∏Å) + ‡∏°‡∏µ exception ‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢
function pickAorAn(noun){
  const w = String(noun||'').trim().toLowerCase();
  if(!w) return 'a';

  // ‡∏Ç‡πâ‡∏≠‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏™‡∏£‡∏∞‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡πÉ‡∏ä‡πâ an)
  const AN_EX = ['hour','honest','heir','herb'];
  if(AN_EX.some(x => w.startsWith(x))) return 'an';

  // ‡∏Ç‡πâ‡∏≠‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏™‡∏£‡∏∞‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ ‡πÅ‡∏ï‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¢‡∏±‡∏ç‡∏ä‡∏ô‡∏∞ (‡πÉ‡∏ä‡πâ a)
  const A_EX = ['university','unit','user','unicorn','one','european'];
  if(A_EX.some(x => w.startsWith(x))) return 'a';

  const first = w[0];
  return 'aeiou'.includes(first) ? 'an' : 'a';
}

// ‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏ö‡∏ö 2 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î (‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö btn-line1/btn-line2 ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏ö‡∏≠‡∏™)
function setAnswerButtonsTwoLines(leftLine1, leftLine2, rightLine1, rightLine2){
  const leftBtn  = document.getElementById('btnTrueBlend');
  const rightBtn = document.getElementById('btnFalseBlend');

  if(leftBtn){
    leftBtn.innerHTML = `
      <div class="btn-content">
        <div class="btn-text">
          <span class="btn-line1">${leftLine1 || ''}</span>
          <span class="btn-line2">${leftLine2 || ''}</span>
        </div>
      </div>`;
    leftBtn.setAttribute('aria-label','‡πÄ‡∏•‡∏∑‡∏≠‡∏Å '+(leftLine1||''));
  }

  if(rightBtn){
    rightBtn.innerHTML = `
      <div class="btn-content">
        <div class="btn-text">
          <span class="btn-line1">${rightLine1 || ''}</span>
          <span class="btn-line2">${rightLine2 || ''}</span>
        </div>
      </div>`;
    rightBtn.setAttribute('aria-label','‡πÄ‡∏•‡∏∑‡∏≠‡∏Å '+(rightLine1||''));
  }
}

function setAnswerButtonLabels(){
  const meta = LEVEL_META[currentLevel] || LEVEL_META[1];
  setAnswerButtonsTwoLines(meta.left1, meta.left2, meta.right1, meta.right2);
}

function applyAnswerLineSizesByLevel(lv){
  const root = document.documentElement;

  if(lv === 2){
    root.style.setProperty('--btnLine1Size', 'clamp(22px, 3.0vw, 44px)');
    root.style.setProperty('--btnLine2Size', 'clamp(30px, 4.2vw, 64px)');

  }else if(lv === 3){
    root.style.setProperty('--btnLine1Size', 'clamp(22px, 3.0vw, 44px)');
    root.style.setProperty('--btnLine2Size', 'clamp(30px, 4.2vw, 64px)');

  }else{
    root.style.removeProperty('--btnLine1Size');
    root.style.removeProperty('--btnLine2Size');
  }
}

/* ‚úÖ NEW: ‡∏™‡∏∏‡πà‡∏°‡∏™‡∏µ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ã‡πâ‡∏≤‡∏¢/‡∏Ç‡∏ß‡∏≤ (‡πÄ‡∏Å‡∏£‡πÄ‡∏î‡∏µ‡∏¢‡∏ô‡∏ï‡πå‡∏™‡∏î‡πÉ‡∏™‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å) */
const ANSWER_GRAD_POOL = [
  ['#ff6fd8','#ff9a3d'],
  ['#7c3aed','#22c55e'],
  ['#06b6d4','#3b82f6'],
  ['#f43f5e','#fb7185'],
  ['#f59e0b','#f97316'],
  ['#34d399','#22c55e'],
  ['#60a5fa','#a78bfa'],
  ['#fb7185','#f472b6'],
  ['#22c55e','#a3e635'],
  ['#38bdf8','#34d399'],
  ['#c084fc','#f472b6'],
  ['#fda4af','#fbbf24']
];

let __lastLeftGrad  = -1;
let __lastRightGrad = -1;

function applyRandomAnswerGradients(){
  const root = document.documentElement;
  const n = ANSWER_GRAD_POOL.length;
  if(!n) return;

  // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ã‡πâ‡∏≤‡∏¢ (‡∏Å‡∏±‡∏ô‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ö‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô)
  let L = (Math.random() * n) | 0;
  if(n > 1 && L === __lastLeftGrad) L = (L + 1 + ((Math.random()*(n-1))|0)) % n;

  // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏ß‡∏≤ (‡∏Å‡∏±‡∏ô‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ö‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡∏∞‡∏Å‡∏±‡∏ô‡∏ä‡∏ô‡∏Å‡∏±‡∏ö‡∏ã‡πâ‡∏≤‡∏¢)
  let R = (Math.random() * n) | 0;
  if(n > 1 && R === __lastRightGrad) R = (R + 1 + ((Math.random()*(n-1))|0)) % n;
  if(n > 1 && R === L) R = (R + 1) % n;

  __lastLeftGrad = L;
  __lastRightGrad = R;

  const [lA, lB] = ANSWER_GRAD_POOL[L];
  const [rA, rB] = ANSWER_GRAD_POOL[R];

  root.style.setProperty('--btnLeftA',  lA);
  root.style.setProperty('--btnLeftB',  lB);
  root.style.setProperty('--btnRightA', rA);
  root.style.setProperty('--btnRightB', rB);
}

function showQuestion(){
  waitingNext = false;
  canAnswer   = true;
  showNextButton(false);
  questionCount++;

  if(idx>=pool.length){ idx=0 }
  const item = pool[idx++];

  // üé® ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° "‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠" ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
  const palettes = [
    ['#ff8a00','#e52e71'],
    ['#00dbde','#fc00ff'],
    ['#00c6ff','#0072ff'],
    ['#f9d423','#ff4e50'],
    ['#4facfe','#00f2fe'],
    ['#f77062','#fe5196'],
    ['#43e97b','#38f9d7'],
    ['#fa709a','#fee140']
  ];

  const pick = palettes[(Math.random()*palettes.length)|0];
  const grad = `linear-gradient(135deg, ${pick[0]}, ${pick[1]})`;
  qBox.style.setProperty('--qbox-bg', grad);
  applyRandomAnswerGradients();

  // ‚úÖ ‡∏î‡πà‡∏≤‡∏ô 1‚Äì3: ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ + caption ‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å pool ‡∏î‡πà‡∏≤‡∏ô 1 ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î

  if(currentLevel===1 || currentLevel===2 || currentLevel===3){
    qImg.style.display = 'block';
    qImg.src = item.src;

const noun = (item.caption || '').trim();
qCap.textContent = noun;

    // ‡πÄ‡∏â‡∏•‡∏¢: true = ‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢‡∏ñ‡∏π‡∏Å (countable), false = ‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤‡∏ñ‡∏π‡∏Å (uncountable)
    qBox.dataset.answer = item.isTrue ? 'true' : 'false';


    // ‚úÖ ‡∏î‡πà‡∏≤‡∏ô 2/3: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ‚Äú‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ö‡∏ô‡∏õ‡∏∏‡πà‡∏°‚Äù ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ï‡∏≤‡∏° caption
    if(currentLevel===2){
      const art = pickAorAn(noun);
      // ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ö‡∏ô: There is
      // ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏•‡πà‡∏≤‡∏á: a/an + noun  |  some + noun
      setAnswerButtonsTwoLines(
        `There is`, `${art} ${noun}`,
        `There is`, `some ${noun}`
      );

}else if(currentLevel===3){

  // ‡πÇ‡∏ä‡∏ß‡πå‡∏Å‡πà‡∏≠‡∏ô (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ï‡∏¥‡∏° s)
  setAnswerButtonsTwoLines(
    `How many`, `${noun}?`,
    `How much`, `${noun}?`
  );

  // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ï‡∏±‡∏ß‡πÄ‡∏Å‡πà‡∏≤
  if(btnPluralT){ clearTimeout(btnPluralT); btnPluralT=null; }

  // ‡∏Ñ‡∏£‡∏ö 2 ‡∏ß‡∏¥ ‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏ï‡∏¥‡∏° s ‡∏™‡∏µ‡πÅ‡∏î‡∏á‡∏ö‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏ã‡πâ‡∏≤‡∏¢
  btnPluralT = setTimeout(()=>{
    const leftLine2 = document.querySelector('#btnTrueBlend .btn-line2');
    if(!leftLine2) return;

    // ‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
    if(leftLine2.textContent.trim() !== `${noun}?`) return;

    leftLine2.innerHTML = `${noun}<span class="btn-s">s</span>?`;
  }, 2000);
    }else{

      // ‡∏î‡πà‡∏≤‡∏ô 1: ‡πÉ‡∏ä‡πâ‡∏õ‡πâ‡∏≤‡∏¢‡∏Ñ‡∏á‡∏ó‡∏µ‡πà (‡∏ô‡∏≤‡∏°‡∏ô‡∏±‡∏ö‡πÑ‡∏î‡πâ/‡∏ô‡∏≤‡∏°‡∏ô‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)
      setAnswerButtonLabels();
    }
  }else{
    // (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï: ‡∏î‡πà‡∏≤‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÅ‡∏ö‡∏ö word bank)
    qImg.style.display = 'none';
    qImg.removeAttribute('src');
    qCap.textContent = item.word || '';
    qBox.dataset.answer = item.isTrue ? 'true' : 'false';
  }

  playClone(questionSound, VOL.question);

  // ‚úÖ FIX: ‡∏Å‡∏±‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡πâ‡∏≤‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ out ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
  btnTrue?.classList.remove('out','armed');
  btnFalse?.classList.remove('out','armed');

  // ‡πÇ‡∏ä‡∏ß‡πå‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
  showAnswerButtons(true);

  // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡∏•‡∏≤‡∏™‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô
  qBox.classList.remove('out','in');
  requestAnimationFrame(()=> qBox.classList.add('in'));
}


/* ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ã‡πâ‡∏≤‡∏¢/‡∏Ç‡∏ß‡∏≤ */
const btnTrue  = document.getElementById('btnTrueBlend');
const btnFalse = document.getElementById('btnFalseBlend');

function showAnswerButtons(show){
  const action = show ? 'remove' : 'add';
  btnTrue?.classList[action]('hidden');
  btnFalse?.classList[action]('hidden');
}
showAnswerButtons(false);

function judge(isPickTrue){
  if(paused) return;
  if(waitingNext) return;

  const ans = qBox.dataset.answer === 'true';
  const ok = (isPickTrue === ans);
  score += ok ? 1 : 0;

  emojiHistory.push(ok ? 'üòÑ' : 'üò°');
  renderGold(score);

const anchorEl = isPickTrue ? btnTrue : btnFalse;
flyScoreAtCenter(ok, anchorEl, 0, -40);

/* ‚úÖ ADD: ‡∏ï‡∏≠‡∏ö‡∏ú‡∏¥‡∏î -> ‡πÅ‡∏ü‡∏•‡∏ä‡πÅ‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏à‡∏≠ (‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πâ‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏≠‡∏µ‡πÇ‡∏°‡∏à‡∏¥) */
if(!ok) flashWrongScreen();

answeredCount++;
canAnswer = false;

if(ok) playClone(correctSound, VOL.correct);
else   playClone(wrongSound, VOL.wrong);


  if (judge._busy) return;
  judge._busy = true;

  const leftBtn  = document.getElementById('btnTrueBlend');
  const rightBtn = document.getElementById('btnFalseBlend');

  // ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏≠‡∏≠‡∏Å
  qBox.classList.remove('in');
  qBox.style.animation = 'none';
  void qBox.offsetWidth;
  qBox.style.animation = '';
  qBox.classList.add('out');

  // ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ñ‡πâ‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏ü‡∏î
  if (judge._fadeBtnsT) clearTimeout(judge._fadeBtnsT);
  judge._fadeBtnsT = setTimeout(()=>{
    leftBtn?.classList.add('out');
    rightBtn?.classList.add('out');
  }, CLEAR_DELAY_MS);

  const totalWait = Math.max(QBOX_OUT_MS, CLEAR_DELAY_MS + BTN_FADE_MS);
  if (judge._clearT) clearTimeout(judge._clearT);

  judge._clearT = setTimeout(()=>{

    // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
    qCap.textContent = '';
    qImg.removeAttribute('src');


    leftBtn?.classList.remove('out');
    rightBtn?.classList.remove('out');

    if (answeredCount >= MAX_QUESTIONS){
      judge._busy = false;
      endLevel();
      return;
    }

    showAnswerButtons(false);
    waitingNext = true;
    showNextButton(true);

    judge._busy = false;
  }, totalWait + 30);
}

btnTrue.addEventListener('click',  ()=>judge(true));
btnFalse.addEventListener('click', ()=>judge(false));

nextQuestionBtn?.addEventListener('click', ()=>{
  if(!waitingNext || ended) return;

  // ‚úÖ ‡∏Å‡∏±‡∏ô‡πÄ‡∏î‡πâ‡∏á‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á
  if(nextHintDelayT){ clearTimeout(nextHintDelayT); nextHintDelayT=null; }

  showNextButton(false);
  waitingNext = false;
  showQuestion();
});


/* ---------- ‡πÑ‡∏•‡∏ü‡πå‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•‡πÄ‡∏Å‡∏° ---------- */
/* ---------- ‡πÑ‡∏•‡∏ü‡πå‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•‡πÄ‡∏Å‡∏° ---------- */
function resetState(){
  // ‚úÖ ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
  cancelPendingFlows();

  running=false; ended=true; paused=false;
  clearTimeout(gameTimerId); gameTimerId=null;
  score=0; round=0;
  emojiHistory = [];
  renderGold(score);
  answeredCount = 0;
  qCap.textContent='';
  qImg.removeAttribute('src');
  resetClockUI();
  canAnswer   = false;
  waitingNext = false;
  questionCount = 0;
  showAnswerButtons(false);
  showNextButton(false);
}

function startGame(){
  /* ‚úÖ FIX: ‡πÑ‡∏°‡πà‡∏™‡∏∏‡πà‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏≠‡∏ô‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÅ‡∏•‡πâ‡∏ß (‡∏™‡∏∏‡πà‡∏°‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡πà‡∏≤‡∏ô) */
  // applySpecialBg();

  document.body.classList.add('in-game');
  overlay.style.visibility='hidden'; overlay.style.opacity='0';
  ended=false; running=true; paused=false;
  showAnswerButtons(false);

  buildPool(currentLevel);
  idx=0;
  questionCount = 0;

  setAnswerButtonLabels();

  // ‚úÖ NEW: ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡∏ô‡∏≤‡∏î‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ö‡∏ô/‡∏•‡πà‡∏≤‡∏á‡∏ï‡∏≤‡∏°‡∏î‡πà‡∏≤‡∏ô (2‚Äì3 ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
  applyAnswerLineSizesByLevel(currentLevel);

  try{ placeQuestionFollowHead(); }catch(_){}
  showQuestion();

  bgm?.play?.().catch(()=>{});
}

function getBadgeEmoji(sc){
  if (sc<=5)  return 'üèÜ';
  if (sc<=10) return 'üèÜüèÜ';
  if (sc<=15) return 'üèÜüèÜüèÜ';
  return 'üèÜ';
}
function endLevel(){
  // ‚úÖ ‡∏Å‡∏±‡∏ô‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
  cancelPendingFlows();

  ended=true; running=false; paused=false;
  clearTimeout(gameTimerId); gameTimerId=null;
  stopClockUI();
  finalScoreEl.textContent = String(score);
  document.getElementById('scoreBadge').textContent = getBadgeEmoji(score);
  overlay.style.visibility='visible';
  overlay.style.opacity='1';

  qCap.textContent = '';
  qImg.removeAttribute('src');
  qBox.classList.remove('in','out');

  showAnswerButtons(false);
  showNextButton(false);
  waitingNext = false;
  canAnswer = false;

  bgm?.pause?.();
  playClone(winSound, VOL.win);
}

/* ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏∏‡∏°‡πÄ‡∏Å‡∏° (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°) */
pauseBtn.addEventListener('click', ()=>{
  if(!running || ended) return;
  paused = !paused;
  pauseBtn.textContent = paused ? '‚ñ∂Ô∏è ‡∏ï‡πà‡∏≠' : '‚è∏ ‡∏´‡∏¢‡∏∏‡∏î';
});

/* ‚úÖ NEW: ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏ä‡πá‡∏Å‡πÇ‡∏ä‡∏ß‡πå plus ‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÄ‡∏≠‡∏á (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á) */
plusCamTestBtn?.addEventListener('click', ()=>{
  const on = document.body.classList.toggle('cam-on');
  plusCamTestBtn.textContent = on ? '‚ú® Plus‡∏û‡∏¥‡πÄ‡∏®‡∏©: ‡πÄ‡∏õ‡∏¥‡∏î' : '‚ú® Plus‡∏û‡∏¥‡πÄ‡∏®‡∏©: ‡∏õ‡∏¥‡∏î';
});

restartBtn.addEventListener('click', ()=>{
  overlay.style.visibility='hidden'; overlay.style.opacity='0';
  resetState();

  /* ‚úÖ NEW: ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà -> ‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏ã‡πá‡∏ï plus ‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÉ‡∏´‡∏°‡πà */
  applyRandomPlusCamSet();

  startGame();
});

selectLevelBtn.addEventListener('click', ()=>{
hideCamPlus(); 
  // ‚úÖ ‡∏Å‡∏±‡∏ô timeout ‡∏Ç‡πâ‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡∏°‡∏≤‡∏¢‡∏¥‡∏á‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á
  cancelPendingFlows();

  overlay.style.visibility='hidden'; overlay.style.opacity='0';
  resetState();
  restoreDefaultBg(); /* ‚úÖ NEW */
  document.getElementById('landing').classList.remove('hide');
  document.getElementById('startScreen').style.display='none';
  try{ bgm.currentTime=0; bgm.play()?.catch(()=>{}) }catch(_){}
});

quickRestart.addEventListener('click', ()=>{
hideCamPlus();
  cancelPendingFlows();

  resetState();
  restoreDefaultBg(); /* ‚úÖ NEW */


  document.body.classList.remove('in-game');
  document.getElementById('startScreen').style.display='none';
  document.getElementById('landing').classList.remove('hide');
  try{ bgm.currentTime=0; bgm.play()?.catch(()=>{}) }catch(_){}
});


/* ----- Welcome ‚Üí Landing (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ----- */
(function(){
  const welcome = document.getElementById('welcome');
  const enterBtn = document.getElementById('enterBtn');
  const landing = document.getElementById('landing');
  enterBtn.addEventListener('click', ()=>{
    welcome.classList.add('hide');
    landing.classList.remove('hide');
    bgm?.play?.().catch(()=>{});
  });
})();

/* ----- ‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡πà‡∏≤‡∏ô (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ----- */
(function(){
  const landing=document.getElementById('landing');
  const startScreen=document.getElementById('startScreen');
  const startBtn=document.getElementById('startBtn');
  const countdownEl=document.getElementById('countdown');

  function getMissionTitle(lv){
    const meta = LEVEL_META[lv] || LEVEL_META[1];
    return meta.title;
  }

  document.querySelectorAll('.levelBtn').forEach(btn=>{
    if(btn.id==='guideBtn') return;
btn.addEventListener('click', ()=>{
  currentLevel = Number(btn.dataset.level||1);

  document.getElementById('startTitle').textContent = getMissionTitle(currentLevel);
  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡πâ‡∏≤‡∏¢‡∏õ‡∏∏‡πà‡∏°‡∏ã‡πâ‡∏≤‡∏¢/‡∏Ç‡∏ß‡∏≤‡∏ï‡∏≤‡∏°‡∏î‡πà‡∏≤‡∏ô
  setAnswerButtonLabels();

  // ‚úÖ NEW: ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ö‡∏ô/‡∏•‡πà‡∏≤‡∏á‡∏ï‡∏≤‡∏°‡∏î‡πà‡∏≤‡∏ô (2‚Äì3 ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
  applyAnswerLineSizesByLevel(currentLevel);

  /* ‚úÖ NEW: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡πà‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à -> ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏ó‡∏±‡∏ô‡∏ó‡∏µ */
  applySpecialBg();
  /* ‚úÖ NEW: ‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏ã‡πá‡∏ï plus ‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡∏™‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡πà‡∏≤‡∏ô) */
  applyRandomPlusCamSet();
  document.body.classList.add('prestart');

  landing.classList.add('hide');
  startScreen.style.display='flex';


      if(startBtn){
        startBtn.style.display='inline-block'; startBtn.disabled=false; startBtn.style.pointerEvents='auto';
      }
      if(countdownEl){ countdownEl.style.display='none'; countdownEl.textContent='3' }
    });
  });

  startBtn?.addEventListener('click', ()=>{
    startBtn.disabled=true; startBtn.style.pointerEvents='none'; startBtn.style.display='none';
    let n=3; countdownEl.textContent=n; countdownEl.style.display='block';
    const t=setInterval(()=>{
      n--;
      if(n>0){ countdownEl.textContent=n }
      else{ clearInterval(t); countdownEl.style.display='none'; startScreen.style.display='none'; startGame(); startBtn.disabled=false; startBtn.style.pointerEvents='auto'; }
    },1000);
  });

  document.getElementById('guideBtn')?.addEventListener('click', ()=>{
    landing.classList.add('hide');
    document.getElementById('guideScreen').style.display='flex';
  });
  document.getElementById('guideBack')?.addEventListener('click', ()=>{
    document.getElementById('guideScreen').style.display='none';
    landing.classList.remove('hide');
  });
})();

/* ===== ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° ‚Äú‡∏®‡∏µ‡∏£‡∏©‡∏∞‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° + ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏®‡∏µ‡∏£‡∏©‡∏∞ (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ===== */
window.__HEAD_TRACK__ = { on:false, x: innerWidth/2, y: innerHeight*0.25 };
const HEAD_RADIUS = 28;
const HIT_LOCK_MS = 450;
let lastHitAt = 0;

const EYE_OFFSET_PX = 110;

// --- Smooth follow head position ---
// rolling median + outlier reject + OneEuro + spring
const HIST = [];
const HIST_MAX = 7;

class OneEuro {
  constructor({minCutoff=1.0, beta=0.02, dCutoff=1.0}={}){
    this.minCutoff=minCutoff; this.beta=beta; this.dCutoff=dCutoff;
    this.xPrev=null; this.dxPrev=0; this.tPrev=null;
  }
  _alpha(cutoff, dt){ const tau = 1/(2*Math.PI*cutoff); return 1/(1+tau/dt); }
  filter(x, t){
    if(this.tPrev==null){ this.tPrev=t; this.xPrev=x; return x; }
    const dt = Math.max(1e-3, (t - this.tPrev)/1000);
    const dx = (x - this.xPrev)/dt;
    const aD = this._alpha(this.dCutoff, dt);
    this.dxPrev = aD*dx + (1-aD)*this.dxPrev;
    const cutoff = this.minCutoff + this.beta * Math.abs(this.dxPrev);
    const aX = this._alpha(cutoff, dt);
    const xf = aX*x + (1-aX)*this.xPrev;
    this.xPrev = xf; this.tPrev = t;
    return xf;
  }
}
const euroX = new OneEuro({ minCutoff: 1.2, beta: 0.03, dCutoff: 1.0 });
const euroY = new OneEuro({ minCutoff: 1.4, beta: 0.05, dCutoff: 1.2 });

let smoothX = innerWidth / 2;
let smoothY = innerHeight * 0.25;
let lastTime = performance.now();

function rollingMedian(arr){
  const a=[...arr].sort((p,q)=>p-q);
  const mid=a.length>>1;
  return a.length%2 ? a[mid] : 0.5*(a[mid-1]+a[mid]);
}

function placeQuestionFollowHead(){
  const H = window.__HEAD_TRACK__;

  // ‚úÖ NEW: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° "‡∏ï‡∏£‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á" ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ï‡∏≠‡∏ô‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
  // (‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÉ‡∏ä‡πâ‡∏´‡∏±‡∏ß-‡∏•‡∏≥‡∏ï‡∏±‡∏ß‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÑ‡∏î‡πâ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ headCollideCheck ‡πÉ‡∏ä‡πâ __HEAD_TRACK__ ‡∏≠‡∏¢‡∏π‡πà)
  if(document.body.classList.contains('cam-on')){
    smoothX = innerWidth / 2;
    smoothY = innerHeight * 0.25;
    const root = document.documentElement;
    root.style.setProperty('--qx', '50vw');
    root.style.setProperty('--qy', '50vh');
    return;
  }

  if(!H.on){
    smoothX = innerWidth / 2;
    smoothY = innerHeight * 0.25;
    const root = document.documentElement;
    root.style.setProperty('--qx', '50vw');
    root.style.setProperty('--qy', '50vh');
    return;
  }

  HIST.push({x:H.x, y:H.y});
  if(HIST.length > HIST_MAX) HIST.shift();

  const medX = rollingMedian(HIST.map(p=>p.x));
  const medY = rollingMedian(HIST.map(p=>p.y));

  const distMed = Math.hypot(H.x - medX, H.y - medY);
  const OUTLIER_PX = 120;
  const baseX = (distMed > OUTLIER_PX) ? medX : H.x;
  const baseY = (distMed > OUTLIER_PX) ? medY : H.y;

  const now = performance.now();
  const dt  = Math.max(1e-3, (now - lastTime)/1000);

  const fx = euroX.filter(baseX, now);
  const fy = euroY.filter(baseY, now);

  const OMEGA = 12.0;
  const ZETA  = 1.0;

  if(!placeQuestionFollowHead._vel){
    placeQuestionFollowHead._vel = { x:0, y:0 };
  }
  const v = placeQuestionFollowHead._vel;

  const ax = - (OMEGA*OMEGA)*(smoothX - fx) - (2*ZETA*OMEGA)*v.x;
  v.x += ax * dt;
  smoothX += v.x * dt;

  const ay = - (OMEGA*OMEGA)*(smoothY - fy) - (2*ZETA*OMEGA)*v.y;
  v.y += ay * dt;
  smoothY += v.y * dt;

  const MAX_V = 2000;
  v.x = Math.max(-MAX_V, Math.min(MAX_V, v.x));
  v.y = Math.max(-MAX_V, Math.min(MAX_V, v.y));

  lastTime = now;

  const tx = Math.round(smoothX);
  const ty = Math.round(Math.max(20, smoothY - 80));
  const root = document.documentElement;
  root.style.setProperty('--qx', tx + 'px');
  root.style.setProperty('--qy', ty + 'px');
}


function headCollideCheck(){
  const now = performance.now();
  if(now - lastHitAt < HIT_LOCK_MS) return;
  if(!window.__HEAD_TRACK__.on) return;

  const hx = window.__HEAD_TRACK__.x;
  const hy = window.__HEAD_TRACK__.y;

  const circleIntersectsRect = (cx,cy,r, rc) => {
    const nx = Math.max(rc.left, Math.min(cx, rc.right));
    const ny = Math.max(rc.top,  Math.min(cy, rc.bottom));
    const dx=cx-nx, dy=cy-ny;
    return (dx*dx+dy*dy) <= r*r;
  };

  if (waitingNext && nextQuestionBtn && nextQuestionBtn.style.display !== 'none') {
    const rectNext = nextQuestionBtn.getBoundingClientRect();
    if (circleIntersectsRect(hx, hy, HEAD_RADIUS, rectNext)) {
      lastHitAt = now;
      nextQuestionBtn.click();
    }
    return;
  }

  if (!canAnswer) return;

  const rectTrue  = document.getElementById('btnTrueBlend').getBoundingClientRect();
  const rectFalse = document.getElementById('btnFalseBlend').getBoundingClientRect();

  let armedTrue=false, armedFalse=false;

  if(circleIntersectsRect(hx,hy,HEAD_RADIUS,rectTrue)){
    armedTrue=true;
    document.getElementById('btnTrueBlend').classList.add('armed');
  }else{
    document.getElementById('btnTrueBlend').classList.remove('armed');
  }
  if(circleIntersectsRect(hx,hy,HEAD_RADIUS,rectFalse)){
    armedFalse=true;
    document.getElementById('btnFalseBlend').classList.add('armed');
  }else{
    document.getElementById('btnFalseBlend').classList.remove('armed');
  }

  if(armedTrue || armedFalse){
    lastHitAt = now;
    judge(armedTrue);
  }
}

function rafLoop(){
  if(!ended && !paused){
    placeQuestionFollowHead();
    headCollideCheck();
  }
  requestAnimationFrame(rafLoop);
}
rafLoop();

})(); // end IIFE game core
</script>

<!-- ===== Pose (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ===== -->
<script type="module">
import {PoseLandmarker, FilesetResolver} from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3";
const camBtn = document.getElementById('camBtn');
const video  = document.getElementById('cameraMirror');
const cvs    = document.getElementById('camCanvas');
const ctx    = cvs.getContext('2d', { alpha: true });
const DETECT_W = 320;
let detectCanvas = document.createElement('canvas');
let detectCtx = detectCanvas.getContext('2d', { alpha:false, desynchronized:true });

let CAM_ON=false, landmarker=null, raf=0, stream=null;
const EYE_OFFSET_PX = 110;

function fitCanvas(){ const dpr = CAM_ON? 1 : Math.max(1, window.devicePixelRatio||1); cvs.width=Math.round(innerWidth*dpr); cvs.height=Math.round(innerHeight*dpr); cvs.style.width=innerWidth+'px'; cvs.style.height=innerHeight+'px'; ctx.setTransform(1,0,0,1,0,0); ctx.scale(dpr,dpr) }
fitCanvas(); addEventListener('resize', fitCanvas);
function coverCropRect(){ const vw=video.videoWidth||640, vh=video.videoHeight||480; const sw=innerWidth, sh=innerHeight; const scale=Math.max(sw/vw, sh/vh); const sW=Math.round(sw/scale), sH=Math.round(sh/scale); const sX=Math.round((vw-sW)/2), sY=Math.round((vh-sH)/2); return {sX,sY,sW,sH,vw,vh,sw,sh} }
function mapToScreen(nx,ny){ const {sX,sY,sW,sH,vw,vh,sw,sh} = coverCropRect(); const px=nx*vw, py=ny*vh; const u=(px-sX)/sW, v=(py-sY)/sH; let x=u*sw, y=v*sh; x=sw-x; return {x,y} }

async function ensureLandmarker(){
  if(landmarker) return landmarker;
  const fileset = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm");
  landmarker = await PoseLandmarker.createFromOptions(fileset, {
    baseOptions:{ modelAssetPath:"https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task" },
    runningMode:'VIDEO',
    numPoses:1,
    minPoseDetectionConfidence: .50,
    minPosePresenceConfidence : .60,
    minTrackingConfidence     : .70
  });
  return landmarker;
}

const SHOW_DEBUG=false;

function drawPoseAndHead(res){
  const sw=innerWidth, sh=innerHeight;
  ctx.clearRect(0,0,sw,sh);
  if(!res?.landmarks?.length){
    window.__HEAD_TRACK__.on = false;
    return;
  }

  const lm = res.landmarks[0];
  const lEye = lm[2] || lm[1];
  const rEye = lm[5] || lm[4];
  let ref = null;

  if (lEye && rEye) {
    ref = { x: (lEye.x + rEye.x) / 2, y: (lEye.y + rEye.y) / 2 };
  } else if (lm[0]) {
    ref = lm[0];
  } else {
    window.__HEAD_TRACK__.on = false;
    return;
  }

  const base = mapToScreen(ref.x, ref.y);
  const head = { x: base.x, y: base.y - EYE_OFFSET_PX };

  window.__HEAD_TRACK__.on = true;
  window.__HEAD_TRACK__.x = head.x;
  window.__HEAD_TRACK__.y = head.y;

  if(SHOW_DEBUG){
    ctx.beginPath(); ctx.arc(head.x, head.y-8, 28, 0, Math.PI*2);
    ctx.lineWidth=3; ctx.strokeStyle='#fff'; ctx.stroke();
  }
}

function runLoop(){
  const step=()=>{
    if(!video.videoWidth){ raf=requestAnimationFrame(step); return }
    const now=performance.now();
    try{
      const {sX,sY,sW,sH}=coverCropRect();
      detectCtx.drawImage(video, sX,sY,sW,sH, 0,0, detectCanvas.width, detectCanvas.height);
      const res=landmarker.detectForVideo(detectCanvas, now);
      drawPoseAndHead(res);
    }catch(e){}
    raf=requestAnimationFrame(step);
  };
  raf=requestAnimationFrame(step);
}

async function startCamera(){
  await ensureLandmarker();
  stream = await navigator.mediaDevices.getUserMedia({
    video: { width: 960, height: 540, frameRate: 30, facingMode: 'user' },
    audio: false
  });
  video.srcObject=stream; await video.play().catch(()=>{});
  const vw=video.videoWidth||640, vh=video.videoHeight||480;
  const ratio=vw/vh;
  detectCanvas.width=DETECT_W; detectCanvas.height=Math.round(DETECT_W/ratio);
  video.style.display='block'; cvs.style.display='block';
/* ‚úÖ NEW */
  document.body.classList.add('cam-on'); /* ‚úÖ NEW */

  camBtn.textContent='üì∑ ‡∏Å‡∏•‡πâ‡∏≠‡∏á: ‡πÄ‡∏õ‡∏¥‡∏î'; CAM_ON=true; fitCanvas(); runLoop();
}

function stopCamera(){
  cancelAnimationFrame(raf);
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null }
  try{ video.pause() }catch(e){}
  video.removeAttribute('srcObject');
  video.style.display='none'; cvs.style.display='none';
  ctx.clearRect(0,0,innerWidth,innerHeight);

  document.body.classList.remove('cam-on'); /* ‚úÖ NEW */

  camBtn.textContent='üì∑ ‡∏Å‡∏•‡πâ‡∏≠‡∏á: ‡∏õ‡∏¥‡∏î'; CAM_ON=false; fitCanvas();
  window.__HEAD_TRACK__.on=false;
}


camBtn.addEventListener('click', async ()=>{
  if(!stream){
    try{ await startCamera() }catch(err){ camBtn.textContent='üì∑ ‡∏Å‡∏•‡πâ‡∏≠‡∏á: ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï'; camBtn.disabled=true }
  }else{
    stopCamera();
  }
});
document.addEventListener('visibilitychange', ()=>{ if(document.hidden && stream) stopCamera() });
</script>

<!-- ===== Preload Overlay (‡πÄ‡∏û‡∏¥‡πà‡∏° preload ‡∏£‡∏π‡∏õ pool ‡∏î‡πà‡∏≤‡∏ô 1) ===== -->
<div id="preloadOverlay" style="
  position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
  background:#000c; color:#fff; z-index:99999; flex-direction:column; gap:12px;
  font-weight:900; text-align:center;">
  <div id="preloadText" style="font-size:20px">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ü‡∏•‡πå‚Ä¶ 0%</div>
  <div style="width:min(80vw,480px); height:10px; background:#ffffff22; border-radius:999px; overflow:hidden">
    <div id="preloadBar" style="height:100%; width:0%; background:#10b981; transition:width .2s ease"></div>
  </div>
  <div id="preloadSub" style="font-size:12px;opacity:.85">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</div>
</div>

<script>
(()=> {
  const overlay = document.getElementById('preloadOverlay');
  const textEl  = document.getElementById('preloadText');
  const barEl   = document.getElementById('preloadBar');
  const subEl   = document.getElementById('preloadSub');

  const enterBtn   = document.getElementById('enterBtn');
  const levelBtns  = Array.from(document.querySelectorAll('.levelBtn'));
  function lockUI(lock=true){
    if(enterBtn){
      enterBtn.disabled = lock;
      enterBtn.style.pointerEvents = lock ? 'none' : 'auto';
      enterBtn.style.opacity = lock ? '.5' : '1';
      enterBtn.textContent = lock ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶' : '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÄ‡∏Å‡∏°';
    }
    levelBtns.forEach(b=>{
      b.disabled = lock;
      b.style.pointerEvents = lock ? 'none' : 'auto';
      b.style.opacity = lock ? '.6' : '1';
    });
  }
  lockUI(true);

  const IMAGES = [
    "image/background2.png",
    "image/welcome.png",
    "image/banner2.png",
    "image/guide.png",
    "image/button1.png",
    "image/button2.png",
    "image/plus1.png",
    "image/plus2.png",
    "image/ans.png",
  "image/bg1.png",
  "image/bg2.png",
  "image/bg3.png",
  "image/bg4.png",
  /* ‚úÖ NEW: plus ‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á */
  "image/plus1_cam.png",
  "image/plus2_cam.png",
  "image/plus3_cam.png",
  "image/plus4_cam.png",
  "image/plus5_cam.png",
  "image/plus6_cam.png",
  "image/plus7_cam.png",
  "image/plus8_cam.png",
  "image/plus9_cam.png",
  "image/plus10_cam.png",
  "image/plus11_cam.png",
  "image/plus12_cam.png",
  "image/plus13_cam.png",
  "image/plus14_cam.png",
  "image/plus15_cam.png",
  "image/plus16_cam.png",

  ];

  // ‚úÖ preload ‡∏£‡∏π‡∏õ pool ‡∏î‡πà‡∏≤‡∏ô 1: data1/nouns1-30, data2/nouns1-30
  for(let i=1;i<=30;i++){
    IMAGES.push(`data1/nouns${i}.png`);
  }
  for(let i=1;i<=30;i++){
    IMAGES.push(`data2/nouns${i}.png`);
  }

  const AUDIOS = [
    "image/audio1.mp3",
    "image/win2.mp3",
    "image/bgm3.mp3",
    "image/question.mp3",
    "image/audio.mp3",
    "image/wrong.mp3"
  ];

  const FONTS = [
    "400 24px MyGameFont",
    "700 24px MyGameFont"
  ];

  const tasks = [];

  IMAGES.forEach(src=>{
    tasks.push(()=>new Promise(res=>{
      const img = new Image();
      img.onload = ()=>res({ok:true, src});
      img.onerror= ()=>res({ok:false, src});
      img.src = src;
    }));
  });

  AUDIOS.forEach(src=>{
    tasks.push(()=>new Promise(res=>{
      const a = new Audio();
      a.preload = "auto";
      const done = (ok)=> {
        a.removeEventListener('canplaythrough', onReady);
        a.removeEventListener('loadeddata', onReady);
        a.removeEventListener('error', onErr);
        res({ok, src});
      };
      const onReady = ()=>done(true);
      const onErr   = ()=>done(false);

      a.addEventListener('canplaythrough', onReady, {once:true});
      a.addEventListener('loadeddata', onReady, {once:true});
      a.addEventListener('error', onErr, {once:true});

      const t = setTimeout(()=>done(false), 6000);
      a.addEventListener('canplaythrough', ()=>clearTimeout(t), {once:true});
      a.addEventListener('loadeddata', ()=>clearTimeout(t), {once:true});
      a.addEventListener('error', ()=>clearTimeout(t), {once:true});

      a.src = src;
      a.load();
    }));
  });

  if(document.fonts && document.fonts.load){
    FONTS.forEach(f=>{
      tasks.push(()=>document.fonts.load(f).then(()=>({ok:true, src:f})).catch(()=>({ok:false, src:f})));
    });
  }

  const TOTAL = tasks.length;
  let doneCount = 0;

  function renderProgress(currentSrc){
    const pct = Math.round((doneCount / TOTAL) * 100);
    if(textEl) textEl.textContent = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ü‡∏•‡πå‚Ä¶ ${pct}%`;
    if(barEl) barEl.style.width = pct + "%";
    if(subEl && currentSrc) subEl.textContent = `‡πÇ‡∏´‡∏•‡∏î: ${currentSrc}`;
  }

  async function runPreload(){
    for(const job of tasks){
      const r = await job();
      doneCount++;
      renderProgress(r?.src);
    }

    renderProgress("‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô");
    lockUI(false);

    if(overlay){
      overlay.style.transition = "opacity .35s ease";
      overlay.style.opacity = "0";
      setTimeout(()=>overlay.remove(), 380);
    }
  }

  renderProgress();
  runPreload();
})();
</script>

</body>
</html>


